<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÌïòÏù¥Î∏åÎ¶¨Îìú Î£∏ Ïä§Ï∫êÎÑà</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .method-selector {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .method-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .method-tab {
            flex: 1;
            padding: 12px 8px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            text-align: center;
        }
        
        .method-tab.active {
            background: rgba(255,255,255,0.4);
            transform: scale(1.05);
        }
        
        .camera-section {
            display: none;
        }
        
        .camera-section.active {
            display: block;
        }
        
        .camera-container {
            background: rgba(0,0,0,0.8);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        #videoElement {
            width: 100%;
            max-width: 300px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        #capturedImage {
            width: 100%;
            max-width: 300px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
        }
        
        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-camera {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            color: white;
            box-shadow: 0 4px 15px rgba(255,107,107,0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            box-shadow: 0 4px 15px rgba(78,205,196,0.4);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #51cf66, #40c057);
            color: white;
            box-shadow: 0 4px 15px rgba(81,207,102,0.4);
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .analysis-section {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        
        .analysis-section.active {
            display: block;
        }
        
        .edge-detection-canvas {
            background: white;
            border-radius: 10px;
            margin-bottom: 15px;
            width: 100%;
        }
        
        .detection-results {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .corner-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .corner-item {
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            font-size: 12px;
        }
        
        .walking-section {
            display: block;
        }
        
        .walking-section.active {
            display: block;
        }
        
        .sensor-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .sensor-item {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
        }
        
        .sensor-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .sensor-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .canvas-container {
            background: rgba(255,255,255,0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        #roomCanvas {
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .room-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .room-stat {
            text-align: center;
            color: #333;
        }
        
        .room-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        
        .room-stat-label {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .instructions {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: #ffd700;
        }
        
        .instructions p {
            line-height: 1.5;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .recording-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff4757;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            animation: pulse 2s infinite;
            z-index: 1000;
            display: none;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="recording-indicator" id="recordingIndicator">
        üî¥ Ï∏°Ï†ï Ï§ë...
    </div>
    
    <div class="container">
        <div class="header">
            <h1>üè†üì∏ ÌïòÏù¥Î∏åÎ¶¨Îìú Ïä§Ï∫êÎÑà</h1>
            <p>ÏÇ¨ÏßÑ Ï¥¨ÏòÅ + Í±∏Ïñ¥Îã§ÎãàÍ∏∞ Ï∏°Ï†ï</p>
        </div>
        
        <div class="method-selector">
            <div class="method-tabs">
                <button class="method-tab active" data-method="photo">üì∏ ÏÇ¨ÏßÑ Ï¥¨ÏòÅ</button>
                <button class="method-tab" data-method="walking">üö∂ Í±∏Ïñ¥Îã§ÎãàÍ∏∞</button>
                <button class="method-tab" data-method="hybrid">üîÑ ÌïòÏù¥Î∏åÎ¶¨Îìú</button>
            </div>
        </div>
        
        <!-- ÏÇ¨ÏßÑ Ï¥¨ÏòÅ ÏÑπÏÖò -->
        <div class="camera-section active" id="photoSection">
            <div class="camera-container">
                <video id="videoElement" autoplay playsinline></video>
                <img id="capturedImage" alt="Ï¥¨ÏòÅÎêú Ïù¥ÎØ∏ÏßÄ">
                
                <div class="camera-controls">
                    <button class="btn btn-camera" id="startCameraBtn">Ïπ¥Î©îÎùº ÏãúÏûë</button>
                    <button class="btn btn-primary" id="captureBtn" disabled>üì∏ Ï¥¨ÏòÅ</button>
                    <button class="btn btn-secondary" id="analyzeBtn" disabled>üîç Î∂ÑÏÑù</button>
                </div>
            </div>
            
            <div class="analysis-section" id="analysisSection">
                <h3>üîç Î™®ÏÑúÎ¶¨ Í≤ÄÏ∂ú Í≤∞Í≥º</h3>
                <canvas id="edgeCanvas" class="edge-detection-canvas" width="300" height="200"></canvas>
                
                <div class="detection-results">
                    <div style="font-weight: bold; margin-bottom: 10px;">Í∞êÏßÄÎêú Î™®ÏÑúÎ¶¨</div>
                    <div class="corner-list" id="cornerList"></div>
                </div>
                
                <button class="btn btn-success" id="applyPhotoBtn">üìê ÌèâÎ©¥ÎèÑ Ï†ÅÏö©</button>
            </div>
        </div>
        
        <!-- Í±∏Ïñ¥Îã§ÎãàÍ∏∞ ÏÑπÏÖò -->
        <div class="walking-section" id="walkingSection">
            <div class="sensor-info">
                <div class="sensor-item">
                    <div class="sensor-value" id="orientation">0¬∞</div>
                    <div class="sensor-label">Î∞©Ìñ•</div>
                </div>
                <div class="sensor-item">
                    <div class="sensor-value" id="acceleration">0.0</div>
                    <div class="sensor-label">Í∞ÄÏÜçÎèÑ</div>
                </div>
                <div class="sensor-item">
                    <div class="sensor-value" id="stepCount">0</div>
                    <div class="sensor-label">Í±∏Ïùå Ïàò</div>
                </div>
                <div class="sensor-item">
                    <div class="sensor-value" id="distance">0.0m</div>
                    <div class="sensor-label">Ïù¥ÎèôÍ±∞Î¶¨</div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-primary" id="startWalkingBtn">üö∂ Í±∏Ïñ¥Îã§ÎãàÍ∏∞ ÏãúÏûë</button>
                <button class="btn btn-secondary" id="resetBtn">Ï¥àÍ∏∞Ìôî</button>
            </div>
        </div>
        
        <!-- Í≥µÌÜµ Ï∫îÎ≤ÑÏä§ -->
        <div class="canvas-container">
            <canvas id="roomCanvas" width="300" height="300"></canvas>
            <div class="room-info">
                <div class="room-stat">
                    <div class="room-stat-value" id="roomWidth">0.0m</div>
                    <div class="room-stat-label">Í∞ÄÎ°ú</div>
                </div>
                <div class="room-stat">
                    <div class="room-stat-value" id="roomHeight">0.0m</div>
                    <div class="room-stat-label">ÏÑ∏Î°ú</div>
                </div>
                <div class="room-stat">
                    <div class="room-stat-value" id="roomArea">0.0„é°</div>
                    <div class="room-stat-label">Î©¥Ï†Å</div>
                </div>
                <div class="room-stat">
                    <div class="room-stat-value" id="roomPerimeter">0.0m</div>
                    <div class="room-stat-label">ÎëòÎ†à</div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3>üìã ÏÇ¨Ïö© Î∞©Î≤ï</h3>
            <p><strong>üì∏ ÏÇ¨ÏßÑ Ï¥¨ÏòÅ Î™®Îìú:</strong></p>
            <p>‚Ä¢ Î∞©Ïùò Î™®ÏÑúÎ¶¨Í∞Ä Ïûò Î≥¥Ïù¥ÎèÑÎ°ù Ï¥¨ÏòÅÌïòÏÑ∏Ïöî</p>
            <p>‚Ä¢ AIÍ∞Ä ÏûêÎèôÏúºÎ°ú Î™®ÏÑúÎ¶¨Î•º Í≤ÄÏ∂úÌï©ÎãàÎã§</p>
            <p>‚Ä¢ ÏõêÍ∑ºÎ≤ïÏùÑ Í≥†Î†§Ìï¥ Í±∞Î¶¨Î•º Í≥ÑÏÇ∞Ìï©ÎãàÎã§</p>
            <br>
            <p><strong>üö∂ Í±∏Ïñ¥Îã§ÎãàÍ∏∞ Î™®Îìú:</strong></p>
            <p>‚Ä¢ Î≤ΩÏùÑ Îî∞Îùº Ï≤úÏ≤úÌûà Í±∏Ïñ¥Îã§ÎãàÏÑ∏Ïöî</p>
            <p>‚Ä¢ ÏÑºÏÑúÎ°ú Ï†ïÌôïÌïú Í±∞Î¶¨Î•º Ï∏°Ï†ïÌï©ÎãàÎã§</p>
            <br>
            <p><strong>üîÑ ÌïòÏù¥Î∏åÎ¶¨Îìú Î™®Îìú:</strong></p>
            <p>‚Ä¢ ÏÇ¨ÏßÑÏúºÎ°ú Ï¥àÍ∏∞ Íµ¨Ï°∞Î•º Ïû°Í≥†</p>
            <p>‚Ä¢ Í±∏Ïñ¥Îã§ÎãàÎ©∞ Ï†ïÌôïÌïú ÌÅ¨Í∏∞Î•º Î≥¥Ï†ïÌï©ÎãàÎã§</p>
        </div>
    </div>

    <script>
        class HybridRoomScanner {
            constructor() {
                this.currentMethod = 'photo';
                this.isScanning = false;
                
                // Í±∏Ïñ¥Îã§ÎãàÍ∏∞ Í¥ÄÎ†®
                this.stepCount = 0;
                this.totalDistance = 0;
                this.currentPosition = { x: 150, y: 150 };
                this.path = [];
                this.orientation = 0;
                this.stepThreshold = 12;
                this.lastStepTime = 0;
                this.stepLength = 0.7;
                
                // ÏÇ¨ÏßÑ Î∂ÑÏÑù Í¥ÄÎ†®
                this.videoElement = document.getElementById('videoElement');
                this.capturedImage = document.getElementById('capturedImage');
                this.edgeCanvas = document.getElementById('edgeCanvas');
                this.edgeCtx = this.edgeCanvas.getContext('2d');
                this.stream = null;
                this.imageData = null;
                this.detectedCorners = [];
                
                // Ï∫îÎ≤ÑÏä§
                this.canvas = document.getElementById('roomCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.scale = 50;
                
                this.initializeElements();
                this.setupEventListeners();
                this.drawInitialRoom();
            }
            
            initializeElements() {
                // Î©îÏÜåÎìú ÌÉ≠
                this.methodTabs = document.querySelectorAll('.method-tab');
                
                // ÏÇ¨ÏßÑ Í¥ÄÎ†® Î≤ÑÌäº
                this.startCameraBtn = document.getElementById('startCameraBtn');
                this.captureBtn = document.getElementById('captureBtn');
                this.analyzeBtn = document.getElementById('analyzeBtn');
                this.applyPhotoBtn = document.getElementById('applyPhotoBtn');
                
                // Í±∏Ïñ¥Îã§ÎãàÍ∏∞ Í¥ÄÎ†® Î≤ÑÌäº
                this.startWalkingBtn = document.getElementById('startWalkingBtn');
                this.resetBtn = document.getElementById('resetBtn');
                this.recordingIndicator = document.getElementById('recordingIndicator');
                
                // ÏÑºÏÑú ÎîîÏä§ÌîåÎ†àÏù¥
                this.orientationDisplay = document.getElementById('orientation');
                this.accelerationDisplay = document.getElementById('acceleration');
                this.stepCountDisplay = document.getElementById('stepCount');
                this.distanceDisplay = document.getElementById('distance');
                
                // Î∞© Ï†ïÎ≥¥ ÎîîÏä§ÌîåÎ†àÏù¥
                this.roomWidthDisplay = document.getElementById('roomWidth');
                this.roomHeightDisplay = document.getElementById('roomHeight');
                this.roomAreaDisplay = document.getElementById('roomArea');
                this.roomPerimeterDisplay = document.getElementById('roomPerimeter');
                
                // ÏÑπÏÖòÎì§
                this.photoSection = document.getElementById('photoSection');
                this.walkingSection = document.getElementById('walkingSection');
                this.analysisSection = document.getElementById('analysisSection');
                this.cornerList = document.getElementById('cornerList');
            }
            
            setupEventListeners() {
                // Î©îÏÜåÎìú Î≥ÄÍ≤Ω
                this.methodTabs.forEach(tab => {
                    tab.addEventListener('click', (e) => this.changeMethod(e.target.dataset.method));
                });
                
                // ÏÇ¨ÏßÑ Í¥ÄÎ†® Ïù¥Î≤§Ìä∏
                this.startCameraBtn.addEventListener('click', () => this.startCamera());
                this.captureBtn.addEventListener('click', () => this.capturePhoto());
                this.analyzeBtn.addEventListener('click', () => this.analyzePhoto());
                this.applyPhotoBtn.addEventListener('click', () => this.applyPhotoResults());
                
                // Í±∏Ïñ¥Îã§ÎãàÍ∏∞ Í¥ÄÎ†® Ïù¥Î≤§Ìä∏
                this.startWalkingBtn.addEventListener('click', () => this.toggleWalking());
                this.resetBtn.addEventListener('click', () => this.reset());
            }
            
            changeMethod(method) {
                this.currentMethod = method;
                
                // ÌÉ≠ ÌôúÏÑ±Ìôî
                this.methodTabs.forEach(tab => tab.classList.remove('active'));
                document.querySelector(`[data-method="${method}"]`).classList.add('active');
                
                // ÏÑπÏÖò ÌëúÏãú/Ïà®ÍπÄ
                this.photoSection.classList.remove('active');
                this.walkingSection.classList.remove('active');
                
                if (method === 'photo' || method === 'hybrid') {
                    this.photoSection.classList.add('active');
                }
                if (method === 'walking' || method === 'hybrid') {
                    this.walkingSection.classList.add('active');
                }
            }
            
            async startCamera() {
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            facingMode: 'environment', // ÌõÑÎ©¥ Ïπ¥Î©îÎùº Ïö∞ÏÑ†
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    
                    this.videoElement.srcObject = this.stream;
                    this.startCameraBtn.textContent = 'Ïπ¥Î©îÎùº Ïã§Ìñâ Ï§ë';
                    this.startCameraBtn.disabled = true;
                    this.captureBtn.disabled = false;
                    
                } catch (error) {
                    console.error('Ïπ¥Î©îÎùº Ï†ëÍ∑º Ïã§Ìå®:', error);
                    alert('Ïπ¥Î©îÎùºÏóê Ï†ëÍ∑ºÌï† Ïàò ÏóÜÏäµÎãàÎã§. Í∂åÌïúÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                }
            }
            
            capturePhoto() {
                // Ï∫îÎ≤ÑÏä§Ïóê ÎπÑÎîîÏò§ ÌîÑÎ†àÏûÑ Ï∫°Ï≤ò
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = this.videoElement.videoWidth;
                canvas.height = this.videoElement.videoHeight;
                
                ctx.drawImage(this.videoElement, 0, 0);
                
                // Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                this.imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // Ï∫°Ï≤òÎêú Ïù¥ÎØ∏ÏßÄ ÌëúÏãú
                this.capturedImage.src = canvas.toDataURL();
                this.capturedImage.style.display = 'block';
                this.videoElement.style.display = 'none';
                
                // Ïπ¥Î©îÎùº Ïä§Ìä∏Î¶º Ï†ïÏßÄ
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }
                
                this.captureBtn.disabled = true;
                this.analyzeBtn.disabled = false;
            }
            
            analyzePhoto() {
                if (!this.imageData) return;
                
                // Í∞ÑÎã®Ìïú Ïó£ÏßÄ Í≤ÄÏ∂ú Íµ¨ÌòÑ (Ïã§Ï†úÎ°úÎäî OpenCV.js ÏÇ¨Ïö© Í∂åÏû•)
                const edges = this.detectEdges(this.imageData);
                const corners = this.detectCorners(edges);
                
                this.detectedCorners = corners;
                this.displayEdgeDetection(edges);
                this.displayCorners(corners);
                
                this.analysisSection.classList.add('active');
                this.applyPhotoBtn.disabled = false;
            }
            
            detectEdges(imageData) {
                // Í∞ÑÎã®Ìïú Sobel Ïó£ÏßÄ Í≤ÄÏ∂ú Íµ¨ÌòÑ
                const width = imageData.width;
                const height = imageData.height;
                const data = imageData.data;
                const edges = new Uint8ClampedArray(width * height);
                
                // Sobel ÌïÑÌÑ∞
                const sobelX = [-1, 0, 1, -2, 0, 2, -1, 0, 1];
                const sobelY = [-1, -2, -1, 0, 0, 0, 1, 2, 1];
                
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        let gx = 0, gy = 0;
                        
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const idx = ((y + ky) * width + (x + kx)) * 4;
                                const gray = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
                                const filterIdx = (ky + 1) * 3 + (kx + 1);
                                
                                gx += gray * sobelX[filterIdx];
                                gy += gray * sobelY[filterIdx];
                            }
                        }
                        
                        const magnitude = Math.sqrt(gx * gx + gy * gy);
                        edges[y * width + x] = magnitude > 50 ? 255 : 0;
                    }
                }
                
                return { data: edges, width, height };
            }
            
            detectCorners(edges) {
                // Í∞ÑÎã®Ìïú ÏΩîÎÑà Í≤ÄÏ∂ú (Ïã§Ï†úÎ°úÎäî Harris Corner Detection ÏÇ¨Ïö© Í∂åÏû•)
                const corners = [];
                const width = edges.width;
                const height = edges.height;
                const data = edges.data;
                
                // Ïù¥ÎØ∏ÏßÄÎ•º Í≤©ÏûêÎ°ú ÎÇòÎàÑÏñ¥ Í∞Å ÏòÅÏó≠ÏóêÏÑú Ïó£ÏßÄÍ∞Ä ÎßéÏù¥ ÍµêÏ∞®ÌïòÎäî Ï†ê Ï∞æÍ∏∞
                const gridSize = 50;
                
                for (let y = gridSize; y < height - gridSize; y += gridSize) {
                    for (let x = gridSize; x < width - gridSize; x += gridSize) {
                        let edgeCount = 0;
                        
                        // Ï£ºÎ≥Ä ÏòÅÏó≠Ïùò Ïó£ÏßÄ Î∞ÄÎèÑ Í≥ÑÏÇ∞
                        for (let dy = -10; dy <= 10; dy++) {
                            for (let dx = -10; dx <= 10; dx++) {
                                if (data[(y + dy) * width + (x + dx)] > 128) {
                                    edgeCount++;
                                }
                            }
                        }
                        
                        // ÏùºÏ†ï ÏûÑÍ≥ÑÍ∞íÏùÑ ÎÑòÏúºÎ©¥ ÏΩîÎÑàÎ°ú ÌåêÎã®
                        if (edgeCount > 20) {
                            corners.push({ 
                                x: x, 
                                y: y, 
                                strength: edgeCount,
                                realX: (x / width) * 4, // Í∞ÄÏÉÅÏùò Ïã§Ï†ú Ï¢åÌëú (4m Í∏∞Ï§Ä)
                                realY: (y / height) * 3  // Í∞ÄÏÉÅÏùò Ïã§Ï†ú Ï¢åÌëú (3m Í∏∞Ï§Ä)
                            });
                        }
                    }
                }
                
                // Í∞ÄÏû• Í∞ïÌïú ÏΩîÎÑà 4Í∞úÎßå ÏÑ†ÌÉù (Î∞©Ïùò 4Í∞ú Î™®ÏÑúÎ¶¨)
                corners.sort((a, b) => b.strength - a.strength);
                return corners.slice(0, 4);
            }
            
            displayEdgeDetection(edges) {
                this.edgeCanvas.width = Math.min(300, edges.width);
                this.edgeCanvas.height = Math.min(200, edges.height);
                
                const scaleX = this.edgeCanvas.width / edges.width;
                const scaleY = this.edgeCanvas.height / edges.height;
                
                const imageData = this.edgeCtx.createImageData(this.edgeCanvas.width, this.edgeCanvas.height);
                
                for (let y = 0; y < this.edgeCanvas.height; y++) {
                    for (let x = 0; x < this.edgeCanvas.width; x++) {
                        const srcX = Math.floor(x / scaleX);
                        const srcY = Math.floor(y / scaleY);
                        const srcIdx = srcY * edges.width + srcX;
                        const destIdx = (y * this.edgeCanvas.width + x) * 4;
                        
                        const value = edges.data[srcIdx] || 0;
                        imageData.data[destIdx] = value;     // R
                        imageData.data[destIdx + 1] = value; // G
                        imageData.data[destIdx + 2] = value; // B
                        imageData.data[destIdx + 3] = 255;   // A
                    }
                }
                
                this.edgeCtx.putImageData(imageData, 0, 0);
                
                // Í≤ÄÏ∂úÎêú ÏΩîÎÑà ÌëúÏãú
                this.edgeCtx.fillStyle = '#ff6b6b';
                this.detectedCorners.forEach(corner => {
                    this.edgeCtx.beginPath();
                    this.edgeCtx.arc(corner.x * scaleX, corner.y * scaleY, 3, 0, 2 * Math.PI);
                    this.edgeCtx.fill();
                });
            }
            
            displayCorners(corners) {
                this.cornerList.innerHTML = '';
                
                corners.forEach((corner, index) => {
                    const cornerItem = document.createElement('div');
                    cornerItem.className = 'corner-item';
                    cornerItem.innerHTML = `
                        <div>Î™®ÏÑúÎ¶¨ ${index + 1}</div>
                        <div>${corner.realX.toFixed(1)}m, ${corner.realY.toFixed(1)}m</div>
                    `;
                    this.cornerList.appendChild(cornerItem);
                });
            }
            
            applyPhotoResults() {
                if (this.detectedCorners.length < 4) {
                    alert('4Í∞úÏùò Î™®ÏÑúÎ¶¨Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§. Îã§Ïãú Ï¥¨ÏòÅÌï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                
                // Í≤ÄÏ∂úÎêú ÏΩîÎÑàÎì§Î°úÎ∂ÄÌÑ∞ Î∞© ÌÅ¨Í∏∞ Í≥ÑÏÇ∞
                const corners = this.detectedCorners;
                
                // Í∞ÄÏû• ÏôºÏ™Ω, Ïò§Î•∏Ï™Ω, ÏúÑÏ™Ω, ÏïÑÎûòÏ™Ω ÏΩîÎÑà Ï∞æÍ∏∞
                const leftMost = corners.reduce((a, b) => a.realX < b.realX ? a : b);
                const rightMost = corners.reduce((a, b) => a.realX > b.realX ? a : b);
                const topMost = corners.reduce((a, b) => a.realY < b.realY ? a : b);
                const bottomMost = corners.reduce((a, b) => a.realY > b.realY ? a : b);
                
                const width = Math.abs(rightMost.realX - leftMost.realX);
                const height = Math.abs(bottomMost.realY - topMost.realY);
                const area = width * height;
                const perimeter = 2 * (width + height);
                
                // ÌèâÎ©¥ÎèÑÏóê Ï†ÅÏö©
                this.drawPhotoBasedRoom(width, height);
                this.updateRoomInfo(width, height, area, perimeter);
                
                alert(`ÏÇ¨ÏßÑ Î∂ÑÏÑù ÏôÑÎ£å!\nÍ∞ÄÎ°ú: ${width.toFixed(1)}m\nÏÑ∏Î°ú: ${height.toFixed(1)}m\nÎ©¥Ï†Å: ${area.toFixed(1)}„é°`);
            }
            
            drawPhotoBasedRoom(width, height) {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Í≤©Ïûê Í∑∏Î¶¨Í∏∞
                this.drawGrid();
                
                // Ï§ëÏïôÏóê Î∞© Í∑∏Î¶¨Í∏∞
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                const rectWidth = width * this.scale;
                const rectHeight = height * this.scale;
                
                const x = centerX - rectWidth / 2;
                const y = centerY - rectHeight / 2;
                
                // Î∞© Ïô∏Í≥ΩÏÑ†
                this.ctx.strokeStyle = '#667eea';
                this.ctx.lineWidth = 3;
                this.ctx.strokeRect(x, y, rectWidth, rectHeight);
                
                // Î™®ÏÑúÎ¶¨ Ï†êÎì§
                this.ctx.fillStyle = '#ff6b6b';
                const corners = [
                    { x: x, y: y },
                    { x: x + rectWidth, y: y },
                    { x: x + rectWidth, y: y + rectHeight },
                    { x: x, y: y + rectHeight }
                ];
                
                corners.forEach(corner => {
                    this.ctx.beginPath();
                    this.ctx.arc(corner.x, corner.y, 5, 0, 2 * Math.PI);
                    this.ctx.fill();
                });
                
                // Ï§ëÏïôÏóê ÌÖçÏä§Ìä∏
                this.ctx.fillStyle = '#333';
                this.ctx.font = 'bold 14px sans-serif';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('üì∏ ÏÇ¨ÏßÑ Î∂ÑÏÑù Í≤∞Í≥º', centerX, centerY - 10);
                this.ctx.font = '12px sans-serif';
                this.ctx.fillText(`${width.toFixed(1)}m √ó ${height.toFixed(1)}m`, centerX, centerY + 10);
            }
            
            async toggleWalking() {
                if (!this.isScanning) {
                    const hasPermission = await this.requestPermissions();
                    if (!hasPermission) return;
                    this.startWalking();
                } else {
                    this.stopWalking();
                }
            }
            
            async requestPermissions() {
                try {
                    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                        const permission = await DeviceOrientationEvent.requestPermission();
                        if (permission !== 'granted') {
                            alert('ÏÑºÏÑú Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                            return false;
                        }
                    }
                    
                    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                        const permission = await DeviceMotionEvent.requestPermission();
                        if (permission !== 'granted') {
                            alert('Î™®ÏÖò ÏÑºÏÑú Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                            return false;
                        }
                    }
                    
                    return true;
                } catch (error) {
                    console.log('Í∂åÌïú ÏöîÏ≤≠ Ïã§Ìå®:', error);
                    return true;
                }
            }
            
            startWalking() {
                this.isScanning = true;
                this.startWalkingBtn.textContent = 'Ï†ïÏßÄ';
                this.startWalkingBtn.classList.remove('btn-primary');
                this.startWalkingBtn.classList.add('btn-secondary');
                this.recordingIndicator.style.display = 'block';
                
                // ÏÑºÏÑú Ïù¥Î≤§Ìä∏ Îì±Î°ù
                window.addEventListener('deviceorientation', this.handleOrientation.bind(this));
                window.addEventListener('devicemotion', this.handleMotion.bind(this));
                
                this.path = [{ ...this.currentPosition }];
                this.stepCount = 0;
                this.totalDistance = 0;
            }
            
            stopWalking() {
                this.isScanning = false;
                this.startWalkingBtn.textContent = 'üö∂ Í±∏Ïñ¥Îã§ÎãàÍ∏∞ ÏãúÏûë';
                this.startWalkingBtn.classList.remove('btn-secondary');
                this.startWalkingBtn.classList.add('btn-primary');
                this.recordingIndicator.style.display = 'none';
                
                window.removeEventListener('deviceorientation', this.handleOrientation.bind(this));
                window.removeEventListener('devicemotion', this.handleMotion.bind(this));
                
                this.calculateRoomDimensions();
            }
            
            handleOrientation(event) {
                if (!this.isScanning) return;
                this.orientation = event.alpha || 0;
                this.orientationDisplay.textContent = Math.round(this.orientation) + '¬∞';
            }
            
            handleMotion(event) {
                if (!this.isScanning) return;
                
                const acceleration = event.accelerationIncludingGravity;
                if (!acceleration) return;
                
                const totalAcceleration = Math.sqrt(
                    Math.pow(acceleration.x || 0, 2) +
                    Math.pow(acceleration.y || 0, 2) +
                    Math.pow(acceleration.z || 0, 2)
                );
                
                this.accelerationDisplay.textContent = totalAcceleration.toFixed(1);
                this.detectStep(totalAcceleration);
            }
            
            detectStep(acceleration) {
                const now = Date.now();
                if (now - this.lastStepTime < 300) return;
                
                if (acceleration > this.stepThreshold) {
                    this.stepCount++;
                    this.lastStepTime = now;
                    this.updatePosition();
                    this.updateDisplay();
                    this.drawWalkingRoom();
                }
            }
            
            updatePosition() {
                const radians = (this.orientation * Math.PI) / 180;
                const deltaX = Math.sin(radians) * this.stepLength * this.scale;
                const deltaY = -Math.cos(radians) * this.stepLength * this.scale;
                
                this.currentPosition.x += deltaX;
                this.currentPosition.y += deltaY;
                
                this.currentPosition.x = Math.max(10, Math.min(290, this.currentPosition.x));
                this.currentPosition.y = Math.max(10, Math.min(290, this.currentPosition.y));
                
                this.path.push({ ...this.currentPosition });
                this.totalDistance += this.stepLength;
            }
            
            updateDisplay() {
                this.stepCountDisplay.textContent = this.stepCount;
                this.distanceDisplay.textContent = this.totalDistance.toFixed(1) + 'm';
            }
            
            drawWalkingRoom() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.drawGrid();
                
                // Í≤ΩÎ°ú Í∑∏Î¶¨Í∏∞
                if (this.path.length > 1) {
                    this.ctx.strokeStyle = '#4ecdc4';
                    this.ctx.lineWidth = 3;
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.path[0].x, this.path[0].y);
                    
                    for (let i = 1; i < this.path.length; i++) {
                        this.ctx.lineTo(this.path[i].x, this.path[i].y);
                    }
                    this.ctx.stroke();
                }
                
                // ÏãúÏûëÏ†ê
                if (this.path.length > 0) {
                    this.ctx.fillStyle = '#ff6b6b';
                    this.ctx.beginPath();
                    this.ctx.arc(this.path[0].x, this.path[0].y, 4, 0, 2 * Math.PI);
                    this.ctx.fill();
                }
                
                // ÌòÑÏû¨ ÏúÑÏπò
                this.ctx.fillStyle = '#667eea';
                this.ctx.beginPath();
                this.ctx.arc(this.currentPosition.x, this.currentPosition.y, 6, 0, 2 * Math.PI);
                this.ctx.fill();
                
                // Î∞©Ìñ• ÌëúÏãú
                const radians = (this.orientation * Math.PI) / 180;
                const arrowLength = 15;
                const endX = this.currentPosition.x + Math.sin(radians) * arrowLength;
                const endY = this.currentPosition.y - Math.cos(radians) * arrowLength;
                
                this.ctx.strokeStyle = '#667eea';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                this.ctx.moveTo(this.currentPosition.x, this.currentPosition.y);
                this.ctx.lineTo(endX, endY);
                this.ctx.stroke();
            }
            
            calculateRoomDimensions() {
                if (this.path.length < 3) return;
                
                let minX = Math.min(...this.path.map(p => p.x));
                let maxX = Math.max(...this.path.map(p => p.x));
                let minY = Math.min(...this.path.map(p => p.y));
                let maxY = Math.max(...this.path.map(p => p.y));
                
                const width = (maxX - minX) / this.scale;
                const height = (maxY - minY) / this.scale;
                const area = width * height;
                const perimeter = this.totalDistance;
                
                this.updateRoomInfo(width, height, area, perimeter);
                this.drawRoomOutline(minX, minY, maxX, maxY);
            }
            
            updateRoomInfo(width, height, area, perimeter) {
                this.roomWidthDisplay.textContent = width.toFixed(1) + 'm';
                this.roomHeightDisplay.textContent = height.toFixed(1) + 'm';
                this.roomAreaDisplay.textContent = area.toFixed(1) + '„é°';
                this.roomPerimeterDisplay.textContent = perimeter.toFixed(1) + 'm';
            }
            
            drawRoomOutline(minX, minY, maxX, maxY) {
                this.ctx.strokeStyle = '#ff6b6b';
                this.ctx.lineWidth = 2;
                this.ctx.setLineDash([5, 5]);
                this.ctx.strokeRect(minX, minY, maxX - minX, maxY - minY);
                this.ctx.setLineDash([]);
            }
            
            drawGrid() {
                this.ctx.strokeStyle = '#f0f0f0';
                this.ctx.lineWidth = 1;
                for (let i = 0; i <= 300; i += 25) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(i, 0);
                    this.ctx.lineTo(i, 300);
                    this.ctx.stroke();
                    
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, i);
                    this.ctx.lineTo(300, i);
                    this.ctx.stroke();
                }
            }
            
            drawInitialRoom() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.drawGrid();
                
                // ÏãúÏûëÏ†ê ÌëúÏãú
                this.ctx.fillStyle = '#ff6b6b';
                this.ctx.beginPath();
                this.ctx.arc(this.currentPosition.x, this.currentPosition.y, 5, 0, 2 * Math.PI);
                this.ctx.fill();
                
                // ÏïàÎÇ¥ ÌÖçÏä§Ìä∏
                this.ctx.fillStyle = '#999';
                this.ctx.font = '14px sans-serif';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('Î∞©Î≤ïÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî', 150, 150);
            }
            
            reset() {
                // Ïä§Ï∫êÎãù Ï§ëÏßÄ
                if (this.isScanning) {
                    this.stopWalking();
                }
                
                // Ïπ¥Î©îÎùº Ïä§Ìä∏Î¶º Ï†ïÏßÄ
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }
                
                // Î™®Îì† Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
                this.stepCount = 0;
                this.totalDistance = 0;
                this.currentPosition = { x: 150, y: 150 };
                this.path = [];
                this.orientation = 0;
                this.imageData = null;
                this.detectedCorners = [];
                
                // UI Ï¥àÍ∏∞Ìôî
                this.startCameraBtn.textContent = 'Ïπ¥Î©îÎùº ÏãúÏûë';
                this.startCameraBtn.disabled = false;
                this.captureBtn.disabled = true;
                this.analyzeBtn.disabled = true;
                this.applyPhotoBtn.disabled = true;
                
                this.videoElement.style.display = 'block';
                this.capturedImage.style.display = 'none';
                this.analysisSection.classList.remove('active');
                
                // ÎîîÏä§ÌîåÎ†àÏù¥ Ï¥àÍ∏∞Ìôî
                this.orientationDisplay.textContent = '0¬∞';
                this.accelerationDisplay.textContent = '0.0';
                this.stepCountDisplay.textContent = '0';
                this.distanceDisplay.textContent = '0.0m';
                
                this.roomWidthDisplay.textContent = '0.0m';
                this.roomHeightDisplay.textContent = '0.0m';
                this.roomAreaDisplay.textContent = '0.0„é°';
                this.roomPerimeterDisplay.textContent = '0.0m';
                
                this.cornerList.innerHTML = '';
                this.edgeCtx.clearRect(0, 0, this.edgeCanvas.width, this.edgeCanvas.height);
                
                this.drawInitialRoom();
            }
        }
        
        // Ïï± Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', () => {
            new HybridRoomScanner();
        });
    </script>
</body>
</html>
