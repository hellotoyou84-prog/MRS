<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>동영상 룸 스캐너 - 디버그</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f0f0;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
        }
        
        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border: 2px solid #2196f3;
        }
        
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 2px solid #4caf50;
        }
        
        .status.error {
            background: #ffebee;
            color: #c62828;
            border: 2px solid #f44336;
        }
        
        video {
            width: 100%;
            border-radius: 8px;
            margin: 10px 0;
            background: #000;
        }
        
        button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #2196f3;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1976d2;
        }
        
        .btn-success {
            background: #4caf50;
            color: white;
        }
        
        .btn-success:hover {
            background: #388e3c;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .debug-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .timer {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #f44336;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎥 동영상 룸 스캐너</h1>
        
        <div id="status" class="status info">
            시작 준비 중...
        </div>
        
        <video id="video" autoplay playsinline muted style="display: none;"></video>
        
        <div id="timer" class="timer" style="display: none;">00:00</div>
        
        <button id="startBtn" class="btn-primary">📹 카메라 시작</button>
        <button id="recordBtn" class="btn-success" disabled>🔴 녹화 시작</button>
        <button id="stopBtn" class="btn-danger" disabled>⏹️ 녹화 중지</button>
        <button id="testBtn" class="btn-primary">🧪 기능 테스트</button>
        
        <div class="debug-info" id="debugInfo">
            === 디버그 정보 ===<br>
            페이지 로딩 완료...<br>
        </div>
    </div>

    <script>
        // 전역 변수로 디버그 쉽게 하기
        let video, startBtn, recordBtn, stopBtn, testBtn, status, debugInfo, timer;
        let stream = null;
        let mediaRecorder = null;
        let isRecording = false;
        let recordingStartTime = null;
        let timerInterval = null;
        
        // 디버그 로그 함수 (안전한 버전)
        function log(message) {
            console.log(message);
            
            // debugInfo 요소가 있을 때만 화면에 표시
            if (debugInfo && debugInfo.innerHTML !== undefined) {
                const now = new Date().toLocaleTimeString();
                debugInfo.innerHTML += `[${now}] ${message}<br>`;
                debugInfo.scrollTop = debugInfo.scrollHeight;
            }
        }
        
        // 상태 업데이트 함수 (안전한 버전)
        function updateStatus(message, type = 'info') {
            console.log(`상태: ${message}`);
            
            if (status) {
                status.textContent = message;
                status.className = `status ${type}`;
            }
            
            log(`상태: ${message}`);
        }
        
        // 페이지 로드 완료 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM 로딩 시작');
            
            try {
                // 요소들 가져오기
                video = document.getElementById('video');
                startBtn = document.getElementById('startBtn');
                recordBtn = document.getElementById('recordBtn');
                stopBtn = document.getElementById('stopBtn');
                testBtn = document.getElementById('testBtn');
                status = document.getElementById('status');
                debugInfo = document.getElementById('debugInfo');
                timer = document.getElementById('timer');
                
                // 모든 요소가 제대로 찾아졌는지 확인
                const elements = {
                    video, startBtn, recordBtn, stopBtn, testBtn, status, debugInfo, timer
                };
                
                let allFound = true;
                for (let [name, element] of Object.entries(elements)) {
                    if (!element) {
                        console.error(`요소를 찾을 수 없음: ${name}`);
                        allFound = false;
                    }
                }
                
                if (!allFound) {
                    console.error('일부 요소를 찾을 수 없습니다!');
                    return;
                }
                
                console.log('모든 요소 찾기 완료');
                log('DOM 로딩 완료');
                log('모든 요소 찾기 완료');
                
                // 브라우저 호환성 체크
                checkBrowserSupport();
                
                // 이벤트 리스너 등록
                startBtn.addEventListener('click', startCamera);
                recordBtn.addEventListener('click', startRecording);
                stopBtn.addEventListener('click', stopRecording);
                testBtn.addEventListener('click', runTests);
                
                log('이벤트 리스너 등록 완료');
                updateStatus('준비 완료! 카메라 시작 버튼을 누르세요');
                
            } catch (error) {
                console.error('초기화 중 오류:', error);
                alert(`초기화 오류: ${error.message}`);
            }
        });
        
        // 브라우저 호환성 체크
        function checkBrowserSupport() {
            log('=== 브라우저 호환성 체크 ===');
            log(`User Agent: ${navigator.userAgent}`);
            log(`HTTPS: ${location.protocol === 'https:'}`);
            log(`MediaDevices: ${!!navigator.mediaDevices}`);
            log(`getUserMedia: ${!!navigator.mediaDevices?.getUserMedia}`);
            log(`MediaRecorder: ${typeof MediaRecorder !== 'undefined'}`);
            
            if (typeof MediaRecorder !== 'undefined') {
                const formats = ['video/webm', 'video/mp4', 'video/webm;codecs=vp9', 'video/webm;codecs=vp8'];
                log('지원되는 비디오 포맷:');
                formats.forEach(format => {
                    const supported = MediaRecorder.isTypeSupported(format);
                    log(`  ${format}: ${supported ? '✅' : '❌'}`);
                });
            }
        }
        
        // 카메라 시작
        async function startCamera() {
            log('카메라 시작 시도...');
            updateStatus('카메라 권한 요청 중...', 'info');
            
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                log('getUserMedia 호출...');
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                log('스트림 획득 성공');
                
                video.srcObject = stream;
                video.style.display = 'block';
                
                video.onloadedmetadata = function() {
                    log(`비디오 메타데이터 로드: ${video.videoWidth}x${video.videoHeight}`);
                    updateStatus('카메라 준비 완료!', 'success');
                    startBtn.disabled = true;
                    recordBtn.disabled = false;
                };
                
            } catch (error) {
                log(`카메라 시작 실패: ${error.name} - ${error.message}`);
                updateStatus(`카메라 오류: ${error.message}`, 'error');
                
                if (error.name === 'NotAllowedError') {
                    alert('카메라 권한을 허용해주세요!\n\n1. 주소창 왼쪽 자물쇠 클릭\n2. 카메라 → 허용\n3. 페이지 새로고침');
                }
            }
        }
        
        // 녹화 시작
        async function startRecording() {
            if (!stream) {
                alert('먼저 카메라를 시작해주세요');
                return;
            }
            
            log('녹화 시작 시도...');
            
            try {
                // 지원되는 MIME 타입 찾기
                let mimeType = '';
                const types = ['video/webm;codecs=vp9', 'video/webm;codecs=vp8', 'video/webm', 'video/mp4'];
                
                for (let type of types) {
                    if (MediaRecorder.isTypeSupported(type)) {
                        mimeType = type;
                        break;
                    }
                }
                
                log(`사용할 MIME 타입: ${mimeType}`);
                
                const options = mimeType ? { mimeType } : {};
                mediaRecorder = new MediaRecorder(stream, options);
                
                const chunks = [];
                
                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        chunks.push(event.data);
                        log(`데이터 청크 수집: ${event.data.size} bytes`);
                    }
                };
                
                mediaRecorder.onstart = function() {
                    log('녹화 시작됨');
                    isRecording = true;
                    recordingStartTime = Date.now();
                    updateStatus('🔴 녹화 중...', 'error');
                    
                    recordBtn.disabled = true;
                    stopBtn.disabled = false;
                    timer.style.display = 'block';
                    
                    // 타이머 시작
                    timerInterval = setInterval(updateTimer, 1000);
                };
                
                mediaRecorder.onstop = function() {
                    log(`녹화 중지됨. 총 청크: ${chunks.length}`);
                    isRecording = false;
                    updateStatus('녹화 완료!', 'success');
                    
                    recordBtn.disabled = false;
                    stopBtn.disabled = true;
                    timer.style.display = 'none';
                    
                    if (timerInterval) {
                        clearInterval(timerInterval);
                    }
                    
                    // 녹화된 데이터 처리
                    if (chunks.length > 0) {
                        const blob = new Blob(chunks, { type: mimeType });
                        log(`최종 파일 크기: ${blob.size} bytes`);
                        
                        // 다운로드 링크 생성 (테스트용)
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `room_scan_${Date.now()}.webm`;
                        a.textContent = '녹화된 동영상 다운로드';
                        a.style.display = 'block';
                        a.style.margin = '10px 0';
                        a.style.textAlign = 'center';
                        document.querySelector('.container').appendChild(a);
                        
                        log('다운로드 링크 생성됨');
                    }
                };
                
                mediaRecorder.onerror = function(event) {
                    log(`MediaRecorder 오류: ${event.error}`);
                    updateStatus(`녹화 오류: ${event.error}`, 'error');
                };
                
                // 녹화 시작
                mediaRecorder.start(1000); // 1초마다 데이터 수집
                
            } catch (error) {
                log(`녹화 시작 실패: ${error.name} - ${error.message}`);
                updateStatus(`녹화 오류: ${error.message}`, 'error');
            }
        }
        
        // 녹화 중지
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                log('녹화 중지 요청...');
                mediaRecorder.stop();
            }
        }
        
        // 타이머 업데이트
        function updateTimer() {
            if (recordingStartTime) {
                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        // 기능 테스트
        function runTests() {
            log('=== 기능 테스트 시작 ===');
            
            // 기본 테스트
            log('1. 버튼 클릭 테스트: ✅');
            log('2. JavaScript 실행: ✅');
            log('3. 콘솔 로그: ✅');
            
            // 현재 상태 체크
            log(`4. 스트림 상태: ${stream ? '✅ 활성' : '❌ 없음'}`);
            log(`5. 녹화 상태: ${isRecording ? '✅ 진행중' : '❌ 중지'}`);
            log(`6. 비디오 표시: ${video.style.display !== 'none' ? '✅' : '❌'}`);
            
            updateStatus('테스트 완료 - 콘솔 확인', 'info');
            
            // 알림으로도 표시
            alert('기능 테스트 완료!\n콘솔과 디버그 정보를 확인하세요.');
        }
        
        // 전역 오류 처리 (안전한 버전)
        window.onerror = function(message, source, lineno, colno, error) {
            console.error(`전역 오류: ${message} (${source}:${lineno}:${colno})`);
            
            // debugInfo가 있을 때만 화면에 표시
            if (debugInfo && debugInfo.innerHTML !== undefined) {
                const now = new Date().toLocaleTimeString();
                debugInfo.innerHTML += `[${now}] ❌ 오류: ${message}<br>`;
                debugInfo.scrollTop = debugInfo.scrollHeight;
            }
            
            return false;
        };
        
        // Promise 오류 처리 (안전한 버전)
        window.addEventListener('unhandledrejection', function(event) {
            console.error(`Promise 오류: ${event.reason}`);
            
            if (debugInfo && debugInfo.innerHTML !== undefined) {
                const now = new Date().toLocaleTimeString();
                debugInfo.innerHTML += `[${now}] ❌ Promise 오류: ${event.reason}<br>`;
                debugInfo.scrollTop = debugInfo.scrollHeight;
            }
        });
        
        console.log('스크립트 로딩 완료');
        
        // 추가 안전 장치: DOM이 준비되기 전에 실행되는 코드 방지
        if (document.readyState === 'loading') {
            console.log('DOM 아직 로딩 중...');
        } else {
            console.log('DOM 이미 준비됨');
        }
    </script>
</body>
</html>
